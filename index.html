<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Demo by NielsenSalesEngineering</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Demo</h1>
      <h2 class="project-tagline">Reference implementation of the Nielsen App API (iOS)</h2>
      <a href="https://github.com/NielsenSalesEngineering/Demo" class="btn">View on GitHub</a>
      <a href="https://github.com/NielsenSalesEngineering/Demo/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/NielsenSalesEngineering/Demo/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="nielsen-app-api-sdk-implementation" class="anchor" href="#nielsen-app-api-sdk-implementation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Nielsen App API SDK Implementation</h1>

<p>This document will guide you through implementing the Nielsen App API SDK.  Read Nielsen's <a href="http://engineeringforum.nielsen.com/sdk/developers/">Engineering Client Portal</a> for more details and documentation.</p>

<h2>
<a id="implementing-the-sdk" class="anchor" href="#implementing-the-sdk" aria-hidden="true"><span class="octicon octicon-link"></span></a>Implementing the SDK</h2>

<h3>
<a id="configure-the-nielsen-app-sdk" class="anchor" href="#configure-the-nielsen-app-sdk" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configure the Nielsen App SDK</h3>

<h4>
<a id="frameworks" class="anchor" href="#frameworks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Frameworks</h4>

<p>Add the following to Linked Frameworks and Libraries:</p>

<ul>
<li>CoreMedia</li>
<li>AVFoundation</li>
<li>Security</li>
<li>SystemConfiguration</li>
<li>AdSupport</li>
<li>Foundation</li>
<li>UIKit</li>
<li>CoreLocation</li>
<li>libsqlite3.dylib</li>
<li>NielsenAppApi</li>
</ul>

<h4>
<a id="build-settings" class="anchor" href="#build-settings" aria-hidden="true"><span class="octicon octicon-link"></span></a>Build Settings</h4>

<p>Navigate to Build Settings &gt; Linking &gt; Other Linker Flags and add lstdc++ for Any Architecture | Any SDK.</p>

<h3>
<a id="instantiate-the-sdk" class="anchor" href="#instantiate-the-sdk" aria-hidden="true"><span class="octicon octicon-link"></span></a>Instantiate the SDK</h3>

<p><code>[NielsenAppApi initWithAppInfo:delegate:]</code> expects a <code>JSON</code> formatted string, which we construct from a dictionary below.  Delegate methods are documented later in this tutorial.</p>

<pre><code>NSDictionary *nielsenConfig = @{
    @"appid": @"T6DABF79D-CE15-4A47-A201-4E7DFE0F7EF0",
    @"appversion": @"1.0",
    @"appname": @"SDK Demo",
    @"sfcode": @"uat"
};
NSData *jsonDataNielsenConfig = [NSJSONSerialization dataWithJSONObject:nielsenConfig options:0 error:nil];
NSString *jsonStringNielsenConfig = [[NSString alloc] initWithBytes:[jsonDataNielsenConfig bytes] length:[jsonDataNielsenConfig length] encoding:NSUTF8StringEncoding];
nielsenMeter = [[NielsenAppApi alloc] initWithAppInfo:jsonStringNielsenConfig delegate:self];
</code></pre>

<h3>
<a id="player-configuration" class="anchor" href="#player-configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Player Configuration</h3>

<p><code>[NielsenAppApi play:]</code> expects a <code>JSON</code> formatted string, which we construct from a dictionary below.</p>

<pre><code>NSDictionary *playerInfoDict = @{
    @"channelName": @"Video Demo",
    @"adModel": @"2",
    @"dataSrc": @"cms"
};
NSData *playerInfoData = [NSJSONSerialization dataWithJSONObject:playerInfoDict options:0 error:nil];
playerInfo = [[NSString alloc] initWithBytes:[playerInfoData bytes] length:[playerInfoData length] encoding:NSUTF8StringEncoding];
</code></pre>

<h3>
<a id="asset-metadata-configuration" class="anchor" href="#asset-metadata-configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Asset Metadata Configuration</h3>

<p><code>[NielsenAppApi loadMetadata:]</code> expects a <code>JSON</code> formatted string, which we construct from a dictionary below.</p>

<pre><code>NSURL *url = [NSURL URLWithString:@"http://nielsense-assets.s3.amazonaws.com/id3/001/prog_index.m3u8"];
NSDictionary *assetInfoDict = @{
    @"type": @"content",
    @"assetid": @"demo",
    @"tv": @"true",
    @"program": @"Demo Program",
    @"title": @"Demo Episode",
    @"category": @"test",
    @"adModel": @"2",
    @"dataSrc": @"cms"
};
NSData *assetInfoData = [NSJSONSerialization dataWithJSONObject:assetInfoDict options:0 error:nil];
assetInfo = [[NSString alloc] initWithBytes:[assetInfoData bytes] length:[assetInfoData length] encoding:NSUTF8StringEncoding];
</code></pre>

<h3>
<a id="implement-kvo" class="anchor" href="#implement-kvo" aria-hidden="true"><span class="octicon octicon-link"></span></a>Implement KVO</h3>

<p>Register key-value observers on the player's <code>status</code> and <code>rate</code> keys.  If you're using ID3 encoded media, register <code>currentItem.timedMetadata</code>.</p>

<p>Read Apple's <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html">Introduction to Key-Value Observing Programming Guide</a> for an overview of KVO.</p>

<pre><code>[self.avPlayerViewcontroller.player addObserver:self forKeyPath:@"status" options:0 context:nil];
[self.avPlayerViewcontroller.player addObserver:self forKeyPath:@"rate" options:0 context:nil];
[self.avPlayerViewcontroller.player addObserver:self forKeyPath:@"currentItem.timedMetadata" options:0 context:nil];
</code></pre>

<h3>
<a id="updating-playhead-position" class="anchor" href="#updating-playhead-position" aria-hidden="true"><span class="octicon octicon-link"></span></a>Updating Playhead Position</h3>

<p>Observe player every 2 seconds and update <code>[NielsenAppApi playheadPosition:]</code>.</p>

<pre><code>CMTime i = CMTimeMakeWithSeconds(2.0, NSEC_PER_SEC);
__weak typeof(self) weakSelf = self;
[self.avPlayerViewcontroller.player addPeriodicTimeObserverForInterval:i queue:dispatch_get_main_queue() usingBlock:^(CMTime time) {
    NSLog(@"Update playhead position");
    CMTime t = [weakSelf.avPlayerViewcontroller.player currentTime];
    long position = CMTimeGetSeconds(t);
    [nielsenMeter playheadPosition:position];
}];
</code></pre>

<h3>
<a id="observing-play-and-pause-events" class="anchor" href="#observing-play-and-pause-events" aria-hidden="true"><span class="octicon octicon-link"></span></a>Observing Play and Pause Events</h3>

<p>Watch the playback rate for changes to handle pauses.  A rate of 0 is paused.  1 is normal playback.</p>

<pre><code>if ([path isEqualToString:@"rate"]) {
    if ([self.avPlayerViewcontroller.player rate]) {
        NSLog(@"Unpaused.");
        [nielsenMeter play:playerInfo];
        [nielsenMeter loadMetadata:assetInfo];
    } else {
        NSLog(@"Paused.");
        [nielsenMeter stop];
    }
</code></pre>

<h3>
<a id="play-asset" class="anchor" href="#play-asset" aria-hidden="true"><span class="octicon octicon-link"></span></a>Play Asset</h3>

<p>Observe <code>status</code> key to play asset once loaded.</p>

<pre><code>} else if ([path isEqualToString:@"status"]) {
    if (self.avPlayerViewcontroller.player.status == AVPlayerItemStatusReadyToPlay) {
        NSLog(@"Ready to play");
        [self.avPlayerViewcontroller.player play];
        [nielsenMeter play:playerInfo];
    }
</code></pre>

<h3>
<a id="id3-metadata" class="anchor" href="#id3-metadata" aria-hidden="true"><span class="octicon octicon-link"></span></a>ID3 Metadata</h3>

<p>Observe <code>currentItem.timedMetadata</code> and parse ID3 data when fired.</p>

<pre><code>} else if ([path isEqualToString:@"currentItem.timedMetadata"]) {
    NSLog(@"Parsing ID3 content.");
    for (AVMetadataItem *metadataItem in [[player currentItem] timedMetadata]) {
        id extraAttributeType = [metadataItem extraAttributes];
        NSString *extraString = nil;
        if ([extraAttributeType isKindOfClass:[NSDictionary class]]) {
            extraString = [extraAttributeType valueForKey:@"info"];
        }
        else if ([extraAttributeType isKindOfClass:[NSString class]]) {
            extraString = extraAttributeType;
        }
        if ([(NSString *)[metadataItem key] isEqualToString:@"PRIV"] &amp;&amp; [extraString rangeOfString:@"www.nielsen.com"].length &gt; 0) {
            if ([[metadataItem value] isKindOfClass:[NSData class]]) {
                [nielsenMeter sendID3:extraString];
            }
        }
    }
}
</code></pre>

<h3>
<a id="implement-delegate-methods" class="anchor" href="#implement-delegate-methods" aria-hidden="true"><span class="octicon octicon-link"></span></a>Implement Delegate Methods</h3>

<p>Implement <code>[NielsenAppApi eventOccurred:]</code> and <code>[NielsenAppApi errorOccurred:]</code> in order to fulfill the Nielsen App API delegate.  Don't forget to add <code>&lt;NielsenAppApiDelegate&gt;</code> to your view controller's <code>@interface</code>.</p>

<pre><code>- (void)nielsenAppApi:(NielsenAppApi *)appApi eventOccurred:(NSDictionary *)event {
    NSLog(@"Sample player is Notified by a Event : %@", event);
}

- (void)nielsenAppApi:(NielsenAppApi *)appApi errorOccurred:(NSDictionary *)error {
    NSLog(@"Sample player is Notified by an Error : %@", error);
}
</code></pre>

<h2>
<a id="implement-user-opt-out" class="anchor" href="#implement-user-opt-out" aria-hidden="true"><span class="octicon octicon-link"></span></a>Implement User Opt Out</h2>

<p>Your app must provide a means for the user to opt-out of, or opt back into, Nielsen Measurement. To implement the opt-out option, you must include a web view within the app which loads the URL returned by optOutURLString:.  Redirecting the user from app to Safari is not an acceptable implementation.  The URL must be loaded in a web view within your app.</p>

<pre><code>WKWebViewConfiguration *configuration = [[WKWebViewConfiguration alloc] init];
webView = [[WKWebView alloc] initWithFrame:self.view.frame configuration:configuration];
webView.navigationDelegate = self;
NSURL *url = [NSURL URLWithString:[nielsenMeter optOutURLString]];
NSURLRequest *request = [NSURLRequest requestWithURL:url];
[webView loadRequest:request];
</code></pre>

<p>Notify the SDK of the user’s selection by passing the URL to userOptOut.</p>

<pre><code>NSString *finalURL = [NSString stringWithFormat:@"%@", webView.URL];
[nielsenMeter userOptOut:finalURL];
</code></pre>

<h2>
<a id="getting-help" class="anchor" href="#getting-help" aria-hidden="true"><span class="octicon octicon-link"></span></a>Getting Help</h2>

<p>Reach out to <a href="mailto:SalesEngineeringGlobal@nielsen.com">SalesEngineeringGlobal@nielsen.com</a> or visit Nielsen's <a href="http://engineeringforum.nielsen.com/sdk/developers/">Engineering Client Portal</a> for more information.</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/NielsenSalesEngineering/Demo">Demo</a> is maintained by <a href="https://github.com/NielsenSalesEngineering">NielsenSalesEngineering</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-66429798-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
